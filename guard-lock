#!/bin/bash
# AI Sudo Guard - Lock/Unlock Protection
# Makes guard files immutable to prevent tampering

GUARD_DIR="${GUARD_DIR:-$HOME/.local/bin}"
GUARD_FILES=("$GUARD_DIR/sudo" "$GUARD_DIR/sudo-askpass-gui")
HASH_FILE="$HOME/.ai_sudo_guard.sha256"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_status() {
    echo -e "${BLUE}AI Sudo Guard - Protection Status${NC}"
    echo "==================================="

    for file in "${GUARD_FILES[@]}"; do
        if [[ -f "$file" ]]; then
            # Check immutable flag
            if lsattr "$file" 2>/dev/null | grep -q "i"; then
                echo -e "${GREEN}[LOCKED]${NC}   $file"
            else
                echo -e "${YELLOW}[UNLOCKED]${NC} $file"
            fi
        else
            echo -e "${RED}[MISSING]${NC}  $file"
        fi
    done

    echo ""
    if [[ -f "$HASH_FILE" ]]; then
        echo -e "Hash file: ${GREEN}$HASH_FILE${NC}"
        if verify_integrity silent; then
            echo -e "Integrity: ${GREEN}OK${NC}"
        else
            echo -e "Integrity: ${RED}FAILED - FILES MAY BE COMPROMISED${NC}"
        fi
    else
        echo -e "Hash file: ${YELLOW}Not created (run 'guard-lock lock' first)${NC}"
    fi
}

generate_hashes() {
    echo -e "${BLUE}Generating integrity hashes...${NC}"
    > "$HASH_FILE"

    for file in "${GUARD_FILES[@]}"; do
        if [[ -f "$file" ]]; then
            sha256sum "$file" >> "$HASH_FILE"
        fi
    done

    # Also hash the deletion protection script
    if [[ -f "$HOME/.bash_deletion_protection.sh" ]]; then
        sha256sum "$HOME/.bash_deletion_protection.sh" >> "$HASH_FILE"
    fi

    chmod 444 "$HASH_FILE"
    echo -e "${GREEN}Hashes saved to $HASH_FILE${NC}"
}

verify_integrity() {
    local silent="$1"

    if [[ ! -f "$HASH_FILE" ]]; then
        [[ -z "$silent" ]] && echo -e "${YELLOW}No hash file found. Run 'guard-lock lock' first.${NC}"
        return 1
    fi

    if sha256sum -c "$HASH_FILE" --status 2>/dev/null; then
        [[ -z "$silent" ]] && echo -e "${GREEN}All files verified OK${NC}"
        return 0
    else
        [[ -z "$silent" ]] && echo -e "${RED}INTEGRITY CHECK FAILED!${NC}"
        [[ -z "$silent" ]] && sha256sum -c "$HASH_FILE" 2>/dev/null
        return 1
    fi
}

lock_files() {
    echo -e "${BLUE}Locking AI Sudo Guard files...${NC}"
    echo ""

    # Generate hashes first
    generate_hashes
    echo ""

    # Set immutable flag
    local needs_sudo=false
    for file in "${GUARD_FILES[@]}" "$HOME/.bash_deletion_protection.sh" "$HASH_FILE"; do
        if [[ -f "$file" ]]; then
            if ! lsattr "$file" 2>/dev/null | grep -q "i"; then
                needs_sudo=true
                break
            fi
        fi
    done

    if $needs_sudo; then
        echo -e "${YELLOW}Setting immutable flag requires sudo.${NC}"
        echo "This prevents ANY modification, even by root, until unlocked."
        echo ""

        for file in "${GUARD_FILES[@]}" "$HOME/.bash_deletion_protection.sh" "$HASH_FILE"; do
            if [[ -f "$file" ]]; then
                echo "  Locking: $file"
                /usr/bin/sudo chattr +i "$file"
            fi
        done
    fi

    echo ""
    echo -e "${GREEN}Files are now protected.${NC}"
    echo ""
    echo "To modify these files later, first run:"
    echo "  guard-lock unlock"
}

unlock_files() {
    echo -e "${BLUE}Unlocking AI Sudo Guard files...${NC}"
    echo ""
    echo -e "${YELLOW}This will allow modification of guard files.${NC}"
    echo "Only do this if you need to update or uninstall."
    echo ""

    for file in "${GUARD_FILES[@]}" "$HOME/.bash_deletion_protection.sh" "$HASH_FILE"; do
        if [[ -f "$file" ]]; then
            if lsattr "$file" 2>/dev/null | grep -q "i"; then
                echo "  Unlocking: $file"
                /usr/bin/sudo chattr -i "$file"
            fi
        fi
    done

    echo ""
    echo -e "${GREEN}Files are now unlocked and can be modified.${NC}"
    echo ""
    echo -e "${YELLOW}Remember to run 'guard-lock lock' when done!${NC}"
}

case "$1" in
    lock)
        lock_files
        ;;
    unlock)
        unlock_files
        ;;
    verify)
        verify_integrity
        ;;
    status|"")
        show_status
        ;;
    *)
        echo "AI Sudo Guard - Lock/Unlock Utility"
        echo ""
        echo "Usage: guard-lock [command]"
        echo ""
        echo "Commands:"
        echo "  lock     - Generate hashes and set immutable flag (requires sudo)"
        echo "  unlock   - Remove immutable flag for editing (requires sudo)"
        echo "  verify   - Check file integrity against saved hashes"
        echo "  status   - Show current protection status (default)"
        echo ""
        echo "Once locked, files cannot be modified even by root until unlocked."
        echo "This prevents attackers from replacing the sudo wrapper."
        ;;
esac
